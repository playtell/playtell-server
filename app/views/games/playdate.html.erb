<% content_for :head do %>
<%= javascript_include_tag 'playdate', 'video', 'jquery.booklet.1.2.0.min', 'jquery.easing.1.3', 'youtube', 'jquery.hotkeys-0.8' %>
<script src="http://staging.tokbox.com/v0.91/js/TB.min.js" type="text/javascript" charset="utf-8"></script> 
<script type="text/javascript">
    var sessionId = "<%= @playdate.video_session_id %>"; 
    var token = "<%= @tok_token %>"; 
	var apiKey = "<%= @api_key %>";
	var session;
	var publisher;

	var PUBLISHER_WIDTH = 200; //128;
	var PUBLISHER_HEIGHT = 150; //96;
			
	var SUBSCRIBER_WIDTH = 200;
	var SUBSCRIBER_HEIGHT = 150;
	
	var KEEPSAKE_WIDTH = 242;
	var KEEPSAKE_HEIGHT = 180;

	var subscribers = {};
	var deviceManager;
		
	var keepsakeCameraOn = false;	
			
	$(document).ready(function() {
		// writes out the page direction so it can be used later.
		// upon success, signals the other player in the playdate to ping the server for the latest view of the book	
		// load setup lightbox
		
		//load image for setup lightbox
		$(function () {
		  var img = new Image();
		  $(img)
		    .load(function () {
		      $(this).hide();

		      $('#loader')
		        .removeClass('loading')
		        .append(this);

		      $(this).fadeIn();
		    })

		    .error(function () {
		      // notify the user that the image could not be loaded
		    })

		    //.attr('src', '/images/flashbox.png')
		    .attr('alt', 'Click Allow if you see the Flash settings box.');
		});
		
		// book setup and display	
		//showBook("<%= @book.title %>", "<%= @playdate.page_num %>", "<%= @book.pages.count %>"); // TODO: change currentPage param to "<%= @playdate.page_num %>"; once pages left: location is reset
		
		// opentok video session setup and display
		
		// Un-comment either of the following to set automatic logging and exception handling.
		// See the exceptionHandler() method below.
		// TB.setLogLevel(TB.DEBUG);
		// TB.addEventListener("exception", exceptionHandler);

		if (TB.checkSystemRequirements() != TB.HAS_REQUIREMENTS) {
			alert('You do not have the minimum system requirements to use this service :(');
		} else {
			session = TB.initSession(sessionId);	// Initialize session
			// Add event listeners to the session
			session.addEventListener('sessionConnected', sessionConnectedHandler);
			session.addEventListener('sessionDisconnected', sessionDisconnectedHandler);
			session.addEventListener('connectionCreated', connectionCreatedHandler);
			session.addEventListener('connectionDestroyed', connectionDestroyedHandler);
			session.addEventListener('streamCreated', streamCreatedHandler);
			session.addEventListener('streamDestroyed', streamDestroyedHandler);
			session.addEventListener('signalReceived', signalReceivedHandler);

			connect();
		}							
		
		$('#connect-link').click(function() {
			connect();
		});
		
		$('#disconnect-link').click(function() {
			disconnect(); //tokbox
			$.get("<%= disconnect_playdate_path %>"); // ragatzi playdate
			// every 3rd playdate, prompt for feedback:
			$('#feedback-lightbox').lightbox_me({
			    centered: true, 
				onClose: function () {
					document.location.href='<%= user_path @current_user %>';
				}
			});
		});
		
		$('a').attr("disabled", true);
		$('#disconnect-link').attr("disabled", false);
		
		$('#fullscreen').click(function() {
			maxWindow();
		});				
	});
			
</script>
<% end %>
	
	<div id="videos">
		<div class="video-content row">
			<div class="video-controls inline-block right-button">
				<p><a href="#" id="disconnect-link" title="End Playdate"></a></p>
				<p><a href="#" id="reconnect-link" title="Bad connection? Click to reconnect"></a></p>
			</div>
			<div class="snapshot-controls inline-block left-button">
				<p><a href="#" id="snapshot-link" title="Say Cheese! Take a photo"></a></p>
			</div>
			<div class="chat-window-container inline-block">
				<div id="fam-camera-holder" class="inline-block"></div>
				<div id="my-camera" class="inline-block"></div>
				<div class="clear"></div>
			</div>
			<div class="clear"></div>
		</div>
		<div class="activity-content row">
			<div class="flash-instructions">
				<%= image_tag "flash_instructions.png" %>
			</div>
			<div class="book-nav hidden">
				<%= render :partial => "bookNav" %>
			</div>
			<div id="player-container" class="hidden"></div>
			<div class="slide-container hidden"></div>
			<div class="book-container hidden">	
				<div id="book">
				</div>
				<div class="back-cover">
					<div class="beginning-container">
						<p><a href="#" id="beginning-banner"></a></p>
						<div class="beginning-text-container">
							<p><a href="#" id="beginning-link"></a></p>
						</div>						
					</div>
					<div class="book-keepsake"> 
						<div id="myCam-keepsake" class="keepsake-camera-container"></div>
						<div id="famCam-keepsake" class="keepsake-camera-container"></div>
					</div>
				</div>
			</div>
			<div class="clear"></div>
		</div>
		<div id="bottom-drawer" class="row">
			<div id="links">
				<!--<p><a href="#" id="contacts-link"></a></p>-->
				<p><a href="#" id="toybox-link" title="Toy Box"></a></p>
				<!--<p><a href="#" id="keepsakes-link"></a></p>-->
			</div>
			<div id="shelf">
				<div class="items">	
					<%= render :partial => "library", :locals => {:books => @books} %>
				</div>				
				<div class="shelf_bg shelf_left_bg inline-block"></div>
				<div class="shelf_bg shelf_mid_bg inline-block"></div>
				<div class="shelf_bg shelf_right_bg inline-block"></div>
			</div>
		</div>
		<div class="clear"></div>
	</div>
	
	<div id="feedback-lightbox" class="lightbox hidden">
		<%= image_tag "mad_scientist.gif", :class => "fl lightbox-scientist-img" %>
		<div class="lightbox-content">
			<div id="thank-you" class="hidden">
				<h2>You're the best!!</h2>
				<h3>Thanks for helping us make Ragatzi better for you.</h3>
				<p>
					<span class="loading"></span> Ending Playdate...
				</p>
			</div>
			<div id="feedback-lightbox-text">
				<h2>Did you enjoy your playdate?</h2>	
				<%= render :partial => "feedback/form", :locals => {:feedback => @feedback} %>
			</div>
		</div>
		<button class="close close-x blue">X</button>
	</div>
